<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Live Games Happening Now!</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  /* Score glow: green for win, red for foul/loss */
  .glow-green {
    color: #22c55e !important; /* Tailwind green-500 */
    transition: color 1s ease;
  }
  .glow-red {
    color: #ef4444 !important; /* Tailwind red-500 */
    transition: color 1s ease;
  }

  /* Analytics bar glow */
  .bar-glow {
    background-color: #facc15 !important; /* Tailwind yellow-400 */
    transition: background-color 1s ease;
  }
  </style>
</head>
<body class="bg-stone-50 text-stone-900">
  <div class="max-w-5xl mx-auto p-4">
    <h1 class="text-2xl font-extrabold mb-4">Live Games Happening Now!</h1>
    <div id="games" class="grid gap-4 md:grid-cols-2"></div>
    <p id="empty" class="text-sm text-stone-500 hidden">No live games yet. Ask someone to turn on “Live score sharing”.</p>
  </div>

  <!-- Firebase (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_jSYoQLlsYvyMkE4fZ4bHFz2fkE70shk",
      authDomain: "guard-scoreboard.firebaseapp.com",
      projectId: "guard-scoreboard",
      storageBucket: "guard-scoreboard.appspot.com",
      messagingSenderId: "491028228431",
      appId: "1:491028228431:web:4c92700d264f5b1aae3d3a",
      measurementId: "G-5Z28C6N29L"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // UI helpers
    const $ = sel => document.querySelector(sel);
    const gamesWrap = $("#games");
    const emptyMsg  = $("#empty");

    const onlyId = location.hash?.replace("#","") || null;
    let prevData = {};

    // Subscribe to live games (order by updatedAt)
    const q = query(collection(db, "games"), orderBy("updatedAt", "desc"));
    onSnapshot(q, (snap) => {
      const docs = [];
      snap.forEach(d => {
        const data = d.data();
        if (data?.status === "live" && (!onlyId || onlyId === d.id)) {
          docs.push({ id: d.id, ...data });
        }
      });
      render(docs);
    });

    function render(items) {
      gamesWrap.innerHTML = "";
      if (!items.length) { emptyMsg.classList.remove("hidden"); return; }
      emptyMsg.classList.add("hidden");

      for (const g of items) {
        gamesWrap.insertAdjacentHTML("beforeend", gameCardHTML(g));

        // Fill per-player scores
        renderScores(g.id, g.players, g.scores);

        // Animate score changes
        animateScoreChanges(g.id, g.players, g.scores);

        // Render mini analytics bars with glow
        renderBars(`foul-${g.id}`, g.players, g.actionStats?.foul || {}, g.id, "foul");
        renderBars(`win-${g.id}`, g.players, g.actionStats?.win || {}, g.id, "win");
        renderBars(`golden-${g.id}`, g.players, g.actionStats?.golden || {}, g.id, "golden");
        renderBars(`bc-${g.id}`, g.players, g.actionStats?.bc || {}, g.id, "bc");

        // Save latest snapshot
        prevData[g.id] = g;
      }
    }

    function gameCardHTML(g) {
      return `
      <div class="rounded-xl bg-white shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="font-bold">${g.title || "Guard Scoreboard"}</div>
          <div class="text-xs text-stone-500">#${g.id.slice(-6)}</div>
        </div>
        <div class="flex flex-wrap gap-2 text-lg font-extrabold tabular-nums" id="scores-${g.id}"></div>

        <div class="mt-3 grid gap-2">
          ${barRow("Total Fouls", `foul-${g.id}`)}
          ${barRow("Total Wins", `win-${g.id}`)}
          ${barRow("Golden Breaks", `golden-${g.id}`)}
          ${barRow("Break Clears", `bc-${g.id}`)}
        </div>
      </div>`;
    }

    function barRow(title, id) {
      return `
        <div>
          <div class="text-xs font-semibold mb-1">${title}</div>
          <div id="${id}" class="flex gap-1"></div>
        </div>`;
    }

    // Render each player's score as a span
    function renderScores(gameId, players, scores) {
      const wrap = document.getElementById(`scores-${gameId}`);
      wrap.innerHTML = "";
      const ids = Object.keys(players).map(n => Number(n)).sort((a,b)=>a-b);

      ids.forEach(id => {
        wrap.insertAdjacentHTML("beforeend", `
          <span id="score-${gameId}-${id}" class="mr-2">
            ${players[id]}: ${scores?.[id] ?? 0}
          </span>
        `);
      });
    }

    // Animate score changes per player
    function animateScoreChanges(gameId, players, scores) {
      const prev = prevData[gameId]?.scores || {};
      Object.keys(players).forEach(pid => {
        const newVal = scores?.[pid] ?? 0;
        const oldVal = prev?.[pid] ?? 0;
        if (newVal !== oldVal) {
          const spanEl = document.getElementById(`score-${gameId}-${pid}`);
          if (!spanEl) return;

          if (newVal > oldVal) {
            spanEl.classList.add("glow-green");
            setTimeout(() => spanEl.classList.remove("glow-green"), 1000);
          } else {
            spanEl.classList.add("glow-red");
            setTimeout(() => spanEl.classList.remove("glow-red"), 1000);
          }

          // Update text value immediately
          spanEl.textContent = `${players[pid]}: ${newVal}`;
        }
      });
    }

    function renderBars(containerId, players, counts, gameId, statType) {
      const wrap = document.getElementById(containerId);
      if (!wrap) return;
      wrap.innerHTML = "";

      const prevStats = prevData[gameId]?.actionStats?.[statType] || {};
      const ids = Object.keys(players).map(n => Number(n)).sort((a,b)=>a-b);
      const max = Math.max(1, ...ids.map(id => (counts[id] || 0)));

      for (const id of ids) {
        const v = counts[id] || 0;
        const pct = Math.round((v / max) * 100);

        const barId = `${containerId}-bar-${id}`;
        wrap.insertAdjacentHTML("beforeend", `
          <div class="flex-1 bg-stone-100 rounded overflow-hidden">
            <div id="${barId}" class="h-3" style="width:${pct}%; background:#3b82f6"></div>
            <div class="text-[10px] text-center mt-1">${players[id]} (${v})</div>
          </div>
        `);

        const prevVal = prevStats?.[id] ?? 0;
        if (v !== prevVal) {
          const barEl = document.getElementById(barId);
          if (barEl) {
            barEl.classList.add("bar-glow");
            setTimeout(() => barEl.classList.remove("bar-glow"), 1000);
          }
        }
      }
    }
  </script>
</body>
</html>
